<html>
  <head>
    <script src="https://cdn.tailwindcss.com"></script>
    <script
      crossorigin
      src="https://unpkg.com/react@18.3.1/umd/react.production.min.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18.3.1/umd/react-dom.production.min.js"
    ></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script>
      window.onerror = function (
        message,
        source,
        lineno,
        colno,
        error,
      ) {
        window.parent.postMessage(
          {
            type: "error",
            data: {
              description: message,
              source: source,
              lineno: lineno,
              colno: colno,
              stacktrace: error && error.stack
                ? error.stack
                : new Error().stack,
            },
          },
          "*",
        );
        return false;
      };

      function useDoc(key) {
        const [doc, setDoc] = React.useState(undefined);

        React.useEffect(() => {
          function handleMessage(event) {
            if (
              event.data &&
              event.data.type === "update" &&
              Array.isArray(event.data.data) &&
              event.data.data[0] === key
            ) {
              setDoc(event.data.data[1]);
            }
          }

          window.addEventListener("message", handleMessage);
          window.parent.postMessage(
            { type: "subscribe", data: key },
            "*",
          );

          return () => {
            window.removeEventListener("message", handleMessage);
            window.parent.postMessage({
              type: "unsubscribe",
              data: key,
            }, "*");
          };
        }, [key]);

        const updateDoc = (newValue) => {
          window.parent.postMessage({
            type: "write",
            data: [key, newValue],
          }, "*");
        };

        return [doc, updateDoc];
      }

      window.llm = (() => {
        const inflight = [];

        async function llm(payload) {
          return new Promise((resolve, reject) => {
            let stringified = JSON.stringify(payload);
            inflight.push([stringified, resolve, reject]);
            window.parent.postMessage({
              type: "llm-request",
              data: stringified,
            }, "*");
          });
        }

        window.addEventListener("message", (e) => {
          if (e.data.type !== "llm-response") {
            return;
          }
          let { request, data, error } = e.data;
          let index = inflight.findIndex(([payload, res, rej]) =>
            request === payload
          );
          if (index !== -1) {
            let [_, res, rej] = inflight[index];
            inflight.splice(index, 1);
            if (data) {
              res(data);
            } else {
              rej(data);
            }
          }
        });
        return llm;
      })();

      window.generateImage = function (prompt) {
        return "/api/ai/img?prompt=" + encodeURIComponent(prompt);
      };
    </script>
    <title>Counter</title>
  </head>

  <body>
    <div id="root"></div>
    <script type="text/babel">
      function Counter() {
        const [doc, updateDoc] = useDoc("counter");

        const handleIncrement = () => {
          if (doc === undefined) {
            updateDoc(1);
          } else {
            updateDoc(doc + 1);
          }
        };

        const handleDecrement = () => {
          if (doc === undefined) {
            updateDoc(0);
          } else {
            updateDoc(doc - 1);
          }
        };

        return (
          <div className="min-h-screen bg-gray-100 flex items-center justify-center">
            <div className="text-center">
              <h1 className="text-5xl font-bold mb-4">Counter</h1>
              <p className="text-3xl mb-8">{doc || 0}</p>
              <button
                className="px-4 py-2 bg-blue-600 text-white rounded"
                onClick={handleIncrement}
              >
                Increment
              </button>
              <button
                className="px-4 py-2 bg-red-600 text-white rounded ml-4"
                onClick={handleDecrement}
              >
                Decrement
              </button>
            </div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<Counter />);
    </script>
  </body>
</html>
